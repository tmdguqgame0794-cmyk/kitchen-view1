<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>관리(5×6) • 합석/시간/데드라인/총금액 • 알고리즘패널</title>
<style>
:root{
  --bg:#0f172a; --panel:#0b1220; --ink:#e5e7eb; --muted:#94a3b8; --line:#233146;
  --accent:#3b82f6; --accent-ink:#fff;
  --blue:#1d4ed8; --green:#16a34a; --gray:#c7ccd3; --red:#dc2626; --yellow:#fde68a;
  --card:#0f172a;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Apple SD Gothic Neo,Helvetica,Arial,sans-serif;overflow:hidden}
.wrap{padding:8px;max-width:1280px;margin:0 auto;height:100vh;display:flex;flex-direction:column}
.toolbar{display:flex;gap:6px;flex-wrap:wrap;margin:0 0 8px}
.btn{border:1px solid var(--line);background:#0b1525;border-radius:10px;padding:6px 10px;font-size:12px;color:var(--ink);cursor:pointer}
.btn.primary{background:var(--accent);color:var(--accent-ink);border-color:#1f49a3}
.btn.warn{border-color:#ef4444;color:#ef4444;background:#1b0d0d}
.btn.ghost{background:#0b152500}
.grid{display:grid;grid-template-columns:repeat(6,1fr);grid-auto-rows:1fr;gap:8px;min-height:0;flex:1}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px;min-width:0;min-height:0;display:flex;flex-direction:column;gap:8px;overflow:auto;contain:content;position:relative}
.card *{min-width:0}
.header{display:flex;align-items:center;justify-content:space-between;gap:8px}
.tid{flex:1;font-weight:900;font-size:clamp(14px,1.45vw,18px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.badge{display:inline-flex;gap:8px;align-items:center;flex-shrink:0}
.chip{border:1px solid #2a3954;border-radius:999px;padding:2px 8px;font-size:12px;color:var(--muted);max-width:160px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.meta{display:flex;gap:8px;flex-wrap:wrap}
.kv{font-size:clamp(11px,1.15vw,13px);color:#cbd5e1;line-height:1.35}
.kv strong{color:#fff}
.sum{font-weight:900;white-space:nowrap}
.row-blue{background:rgba(37,99,235,.18)}
.row-gray{background:rgba(203,205,211,.22)}
.row-red{background:rgba(220,38,38,.20)}
.row-green{background:rgba(22,163,74,.20)}
.row-yellow{background:rgba(253,230,138,.18)}
.row-orange{background:rgba(234,88,12,.22)}
.row-pink{background:rgba(219,39,119,.22)}
.tno-badge{position:absolute;top:6px;left:10px;z-index:2;font-weight:900;font-size:12px;color:#e5e7eb;opacity:.95;pointer-events:none}
.alg{display:flex;flex-direction:column;gap:10px;height:100%}
.alg .line{display:flex;align-items:center;justify-content:space-between;gap:10px}
.alg .left{display:flex;gap:10px;align-items:center;min-width:0}
.alg .menu{font-weight:900;font-size:clamp(13px,1.25vw,16px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.alg .next{font-weight:900;white-space:nowrap}
.alg .check{display:flex;gap:10px;align-items:center;flex-shrink:0}
.alg button{border:1px solid var(--line);background:#0b1525;color:#e5e7eb;border-radius:10px;padding:6px 10px;cursor:pointer;font-size:13px}
.small{font-size:12px;color:#9fb5d6}
.legend{display:flex;gap:6px;flex-wrap:wrap;align-items:center;font-size:11px}
.dot{width:10px;height:10px;border-radius:50%}
.dot.blue{background:#60a5fa}.dot.gray{background:#cbd5e1}.dot.red{background:#fecaca}.dot.green{background:#86efac}.dot.yellow{background:#fde68a}
.groupTag{font-size:11px;color:#93c5fd}
.controls{display:flex;flex-wrap:wrap;gap:8px}
.ppl,.bevs,.menus{display:flex;flex-wrap:wrap;gap:8px}
.tag{border:1px solid #2a3954;border-radius:8px;padding:2px 6px;font-size:12px;color:#e5e7eb;white-space:nowrap}
button.icon{border:1px solid var(--line);background:#0b1525;color:#e5e7eb;border-radius:8px;padding:6px 8px;cursor:pointer;font-size:12px}
.line2{display:flex;justify-content:space-between;align-items:center;gap:8px}
.times{display:flex;gap:8px;flex-wrap:wrap;font-size:12px;color:#cbd5e1}
.times b{color:#e5e7eb}
.tag-mini{border:1px solid #2a3954;border-radius:6px;padding:2px 6px;font-size:10px;color:#cfe1ff;background:#0b1525;}
.note-area{width:100%;height:100%;display:flex;flex-direction:column}
.note-area textarea{flex:1;min-height:0;border:1px solid var(--line);border-radius:10px;background:#0b1525;color:#e5e7eb;padding:10px;font-size:13px}
.note-area .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
</style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <button id="resetAll" class="btn warn">전체 초기화</button>
    <button id="toggleSelect" class="btn">합석 선택</button>
    <button id="makeGroup" class="btn primary" disabled>그룹 만들기</button>
    <button id="breakGroup" class="btn warn" disabled>그룹 해제</button>
    <span class="legend">
      <span class="dot yellow"></span>첫서빙 전(인원/주문 발생) &nbsp;
      <span class="dot blue"></span>진행중 &nbsp;
      <span class="dot gray"></span>50분 경과 &nbsp;
      <span class="dot red"></span>데드라인-10분 &nbsp;
      <span class="dot green"></span>완료
    </span>
  </div>
  <div id="grid" class="grid"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
(function(){
  const CONFIG={menus:["우삼겹숙주볶음","치즈김치전","만두계란탕","불닭콘치즈","치즈콘계란말이","두부김치"],
    prices:{"우삼겹숙주볶음":18000,"치즈김치전":12000,"만두계란탕":16000,"불닭콘치즈":12000,"치즈콘계란말이":11000,"두부김치":12000,"COLA":2000,"CIDER":2000,"ZERO":2000},
    buttonsPerCell:3,tables:24,ROOM_ID:"CHOOKJAE"};
  const STATE_OFF=0, STATE_ACTIVE=1, STATE_SERVED=2;
  const LAYOUT_ROWS=[[5,10,15,18,20,22],[4,9,14,17,19,21],[3,8,13,16],[2,7,12],[1,6,11]];
  const GRID_COLS=6;
  const idxFromTableNo=(no)=> (no>=1&&no<=CONFIG.tables)?(no-1):null;

  const firebaseConfig={apiKey:"AIzaSyCWBPv3YgGKOH0b1e59I3QG9SfRtcNZSDY",authDomain:"chookjae-8e133.firebaseapp.com",projectId:"chookjae-8e133",storageBucket:"chookjae-8e133.firebasestorage.app",messagingSenderId:"82575498649",appId:"1:82575498649:web:364e9c286a9f3ae7474708",measurementId:"G-BQ95TPG37V",databaseURL:"https://chookjae-8e133-default-rtdb.firebaseio.com"};
  try{firebase.initializeApp(firebaseConfig)}catch(e){}
  const db=firebase.database(), ROOM=CONFIG.ROOM_ID;
  const tableRef=(i)=>db.ref('orders/'+ROOM+'/tables/'+i);
  const groupsRef=db.ref('orders/'+ROOM+'/groups');
  const totalsRef=db.ref('orders/'+ROOM+'/footerTotals');
  const memoRef=db.ref('orders/'+ROOM+'/memo');

  function emptyRow(){return{people:0,menu:CONFIG.menus.map(()=>Array(CONFIG.buttonsPerCell).fill(0)),
    bev:{COLA:{qty:0,served:false},CIDER:{qty:0,served:false},ZERO:{qty:0,served:false}},
    time:null,timePlus:null,timeStamp:null,firstOrderedAt:null,firstServedAt:null,done:false,groupId:null,head:null,note:"",call:false,math:false};}
  const rows=Array.from({length:CONFIG.tables},emptyRow); let groups=[];
  const $=(s)=>document.querySelector(s); const grid=$("#grid");
  const fmtWon=new Intl.NumberFormat('ko-KR');
  const pad2=(n)=>String(n).padStart(2,'0');
  const hhmm=(t)=>{if(!t)return null;const d=new Date(t);return pad2(d.getHours())+":"+pad2(d.getMinutes());};
  const plus90=(t)=>{if(!t)return null;const d=new Date(t);d.setMinutes(d.getMinutes()+90);return pad2(d.getHours())+":"+pad2(d.getMinutes());};
  const countOrdered=(arr)=>arr.filter(v=>v!==STATE_OFF).length;
  const countServed =(arr)=>arr.filter(v=>v===STATE_SERVED).length;
  function remainingMenuFor(ti,mi){const r=rows[ti];if(!r)return 0;return Math.max(0,countOrdered(r.menu[mi]||[])-countServed(r.menu[mi]||[]));}
  function orderedFor(ti,mi){const r=rows[ti];if(!r)return 0;return countOrdered(r.menu[mi]||[]);}
  function rowAnyOrdered(r){const m=(r.menu||[]).some(c=>c.some(v=>v!==0));const b=(r.bev?.COLA?.qty+r.bev?.CIDER?.qty+r.bev?.ZERO?.qty)>0;return m||b;}
  function rowAllServed(r){const mDone=(r.menu||[]).every(c=>countOrdered(c)===countServed(c));const bDone=(["COLA","CIDER","ZERO"].every(k=>(r.bev?.[k]?.qty||0)===0||!!(r.bev?.[k]?.served)));return mDone&&bDone&&rowAnyOrdered(r);}
  function rowPrice(r){let s=0;(r.menu||[]).forEach((c,i)=>s+=countOrdered(c)*(CONFIG.prices[CONFIG.menus[i]]||0));
    s+=(r.bev?.COLA?.qty||0)*CONFIG.prices.COLA+(r.bev?.CIDER?.qty||0)*CONFIG.prices.CIDER+(r.bev?.ZERO?.qty||0)*CONFIG.prices.ZERO;return s;}
  const getGroup=(gid)=>(groups||[]).find(x=>x&&x.id===gid)||null;
  const groupMembersIdx=(gid)=>{const g=getGroup(gid);return g?g.members.slice():[];}
  const headOf=(i)=>rows[i].head!=null?rows[i].head:i;
  function aggregateForHead(h){const mem=rows[h].groupId?groupMembersIdx(rows[h].groupId):[h];mem.sort((a,b)=>a-b);
    const fo=Math.min.apply(null,mem.map(mi=>rows[mi].firstOrderedAt||Infinity));
    const fs=Math.min.apply(null,mem.map(mi=>rows[mi].firstServedAt||Infinity));
    const price=mem.reduce((s,mi)=>s+rowPrice(rows[mi]),0);
    return{members:mem,headIdx:h,firstOrderedAt:isFinite(fo)?fo:null,firstServedAt:isFinite(fs)?fs:null,price};}

  /* ★ 다음 나갈 테이블 계산 */
  function nextTableForMenu(menuIdx, isBeverage){
    const heads=[...new Set(rows.map((_,i)=>headOf(i)))].sort((a,b)=>a-b);
    function headRemain(h){
      const mem = rows[h].groupId? groupMembersIdx(rows[h].groupId) : [h];
      if(isBeverage){
        const keys=["COLA","CIDER","ZERO"]; const key=keys[menuIdx];
        return mem.reduce((s,m)=> {
          const r=rows[m]; const q=r?.bev?.[key]?.qty||0; const sv=r?.bev?.[key]?.served||false;
          return s + ((q>0 && !sv)? q : 0);
        },0);
      }else{
        return mem.reduce((s,m)=> s + remainingMenuFor(m, menuIdx), 0);
      }
    }
    const candidates = heads.filter(h=> headRemain(h)>0).map(h=>aggregateForHead(h));
    if(!candidates.length) return null;
    const pool = (candidates.filter(c=>!c.firstServedAt).length ? candidates.filter(c=>!c.firstServedAt) : candidates)
                  .sort((a,b)=>(a.firstOrderedAt||Infinity)-(b.firstOrderedAt||Infinity));
    const chosen = pool[0];
    let member = null;
    if(isBeverage){
      const keys=["COLA","CIDER","ZERO"]; const key=keys[menuIdx];
      member = chosen.members.find(m=>{
        const r=rows[m]; return (r?.bev?.[key]?.qty||0)>0 && !r?.bev?.[key]?.served;
      });
    }else{
      member = chosen.members.find(m=> remainingMenuFor(m, menuIdx) > 0);
    }
    if(member==null) return null;
    return { head: chosen.headIdx, member, tableNo: member+1 };
  }

  function publishTotals(){const sums=Array(CONFIG.menus.length).fill(0);
    rows.forEach(r=>(r.menu||[]).forEach((c,i)=>sums[i]+=c.filter(v=>v===STATE_ACTIVE).length));
    const obj={updatedAt:Date.now()};CONFIG.menus.forEach((n,i)=>obj[n]=sums[i]||0);totalsRef.set(obj);}

  /* === 상태색 계산 (요청: 빨강 > 회색 > 초록 > 파랑 > 노랑), 수학과(핑크)는 예외 === */
  function stateClass(r){
    if(r.math) return 'row-pink';          // 예외 1
    if(r.call) return 'row-orange';        // 기존 호출 표시 유지

    const anyBeforeServe = (r.people>0 || rowAnyOrdered(r)) && !r.firstServedAt;
    if(!r.firstServedAt){
      return anyBeforeServe ? 'row-yellow' : '';
    }

    const now = Date.now();
    const elapsed = now - r.firstServedAt;              // 경과
    const remain  = (r.firstServedAt + 90*60*1000) - now; // 남은

    // 우선순위 적용
    if(remain <= 10*60*1000) return 'row-red';            // 데드라인-10분
    if(elapsed >= 50*60*1000) return 'row-gray';          // 첫 서빙 후 50분
    if(rowAllServed(r) || r.done) return 'row-green';     // 완료
    return 'row-blue';                                     // 진행중
  }

  const patchRow=(i,p)=>tableRef(i).update(p);

  function markOneServed(ti,mi){
    const r=rows[ti],st=r.menu[mi]||[];const k=st.findIndex(v=>v===STATE_ACTIVE);if(k===-1)return;st[k]=STATE_SERVED;
    if(!r.firstServedAt){
      const ts=Date.now();
      if(r.groupId){
        groupMembersIdx(r.groupId).forEach(mi2=>tableRef(mi2).update({menu:rows[mi2].menu,firstServedAt:ts}));
      }else{
        tableRef(ti).update({menu:r.menu,firstServedAt:ts});
      }
    }else{
      tableRef(ti).update({menu:r.menu});
    }
    publishTotals();
  }

  /* ★ 음료 서빙 시에도 첫 서빙 시간이 없으면 타이머 시작하도록 수정 */
  function markBeverageServed(ti,bi){
    const keys=["COLA","CIDER","ZERO"];const key=keys[bi];const r=rows[ti];const b=r?.bev?.[key];if(!b||b.qty<=0)return;
    b.qty=0; b.served=true;
    if(!r.firstServedAt){
      const ts=Date.now();
      if(r.groupId){
        groupMembersIdx(r.groupId).forEach(mi2=>{
          const rr=rows[mi2]; const bb=rr.bev||r.bev;
          tableRef(mi2).update({bev:bb,firstServedAt:ts});
        });
      }else{
        tableRef(ti).update({bev:r.bev,firstServedAt:ts});
      }
    }else{
      tableRef(ti).update({bev:r.bev});
    }
  }

  function render(){
    grid.innerHTML='';
    LAYOUT_ROWS.forEach((rowArr,rI)=>{
      for(let c=0;c<GRID_COLS;c++){
        const val=rowArr[c]; if(val==null)continue;
        const card=document.createElement('div');card.className='card';card.style.gridRow=String(rI+1);card.style.gridColumn=String(c+1);
        const tno=val,tidx=idxFromTableNo(tno);const r=rows[tidx]||emptyRow();const cls=stateClass(r);if(cls)card.classList.add(cls);
        const isGrouped=r.groupId!=null;const headIdx=(r.head!=null?r.head:tidx);const agg=aggregateForHead(headIdx);

        const tBadge=document.createElement('div');tBadge.className='tno-badge';tBadge.textContent=tno+'번';card.appendChild(tBadge);

        const title='<div class="tid">'+tno+'번'+(isGrouped?' <span class="groupTag">헤드='+(headIdx+1)+'</span>':'')+'</div>';
        const right=document.createElement('div');right.className='badge';
        const pplTag=document.createElement('span');pplTag.className='chip';pplTag.textContent='인원 '+(r.people||0);
        const mathWrap=document.createElement('label');mathWrap.className='chip';mathWrap.style.cursor='pointer';
        mathWrap.innerHTML='<input type="checkbox" style="vertical-align:middle;margin-right:6px" '+(r.math?'checked':'')+'> 수학과';
        mathWrap.querySelector('input').onchange=(e)=>{patchRow(tidx,{math:e.target.checked});};
        const callBtn=document.createElement('button');callBtn.className='btn';callBtn.textContent='호출완료';
        callBtn.onclick=()=>{if(r.call){patchRow(tidx,{call:false});}}; if(!r.call){callBtn.disabled=true;callBtn.style.opacity='0.6';}
        right.appendChild(pplTag);right.appendChild(mathWrap);right.appendChild(callBtn);
        card.innerHTML+='<div class="header">'+title+'</div>';card.querySelector('.header').appendChild(right);

        /* ▼▼▼ 합석 비헤드 오버레이 ▼▼▼ */
        if (isGrouped && tidx !== headIdx) {
          const x = document.createElement('div');
          x.textContent = 'X';
          x.style.position = 'absolute';
          x.style.inset = '0';
          x.style.display = 'flex';
          x.style.alignItems = 'center';
          x.style.justifyContent = 'center';
          x.style.fontWeight = '900';
          x.style.fontSize = '48px';
          x.style.color = 'rgba(239,68,68,.9)';
          x.style.pointerEvents = 'none';
          x.style.userSelect = 'none';
          card.appendChild(x);
        }
        /* ▲▲▲ */

        const times=document.createElement('div');times.className='times';
        const fs=hhmm(agg.firstServedAt),dl=plus90(agg.firstServedAt);
        times.innerHTML=(fs&&dl)?('<b>첫서빙</b> '+fs+' · <b>데드라인</b> '+dl):'—';card.appendChild(times);

        const controls=document.createElement('div');controls.className='controls';
        const ppl=document.createElement('div');ppl.className='ppl';
        const pTag=document.createElement('div');pTag.className='tag';pTag.textContent='인원 '+(r.people||0);
        const pMinus=document.createElement('button');pMinus.className='icon';pMinus.textContent='–';
        const pPlus=document.createElement('button');pPlus.className='icon';pPlus.textContent='+';
        pMinus.onclick=()=>{const v=Math.max(0,(rows[tidx].people||0)-1);patchRow(tidx,{people:v});};
        pPlus.onclick =()=>{const v=(rows[tidx].people||0)+1;patchRow(tidx,{people:v});};
        ppl.appendChild(pTag);ppl.appendChild(pMinus);ppl.appendChild(pPlus);

        const bevs=document.createElement('div');bevs.className='bevs';
        [["COLA","콜라"],["CIDER","사이다"],["ZERO","제로콜라"]].forEach(([key,label],bi)=>{
          const qty=r.bev?.[key]?.qty||0; const served=r.bev?.[key]?.served||false;
          const tag=document.createElement('div');tag.className='tag';tag.textContent=label+' '+qty+(qty>0?(served?' (서빙)':' (대기)'):'');
          const m=document.createElement('button');m.className='icon';m.textContent='–';
          const p=document.createElement('button');p.className='icon';p.textContent='+';
          m.onclick=()=>{const cur=rows[tidx];const q=Math.max(0,(cur.bev?.[key]?.qty||0)-1);
            cur.bev=cur.bev||{COLA:{qty:0,served:false},CIDER:{qty:0,served:false},ZERO:{qty:0,served:false}};
            cur.bev[key].qty=q; if(q===0)cur.bev[key].served=false; patchRow(tidx,{bev:cur.bev});};
          p.onclick=()=>{const cur=rows[tidx];const q=(cur.bev?.[key]?.qty||0)+1;
            cur.bev=cur.bev||{COLA:{qty:0,served:false},CIDER:{qty:0,served:false},ZERO:{qty:0,served:false}};
            cur.bev[key].qty=q; cur.bev[key].served=false; if(!cur.firstOrderedAt)cur.firstOrderedAt=Date.now();
            patchRow(tidx,{bev:cur.bev,firstOrderedAt:cur.firstOrderedAt});};
          bevs.appendChild(tag);bevs.appendChild(m);bevs.appendChild(p);
        });

        const menus=document.createElement('div');menus.className='menus';
        CONFIG.menus.forEach((name,mi)=>{
          const btn=document.createElement('button');btn.className='icon';btn.textContent=name;
          btn.onclick=()=>{const cur=rows[tidx];
            if(!Array.isArray(cur.menu?.[mi]))cur.menu[mi]=Array(CONFIG.buttonsPerCell).fill(0);
            if(cur.menu[mi].every(v=>v!==STATE_OFF) && cur.menu[mi].length<12)cur.menu[mi].push(0);
            const k=cur.menu[mi].findIndex(v=>v===STATE_OFF); if(k!==-1)cur.menu[mi][k]=STATE_ACTIVE;
            if(!cur.firstOrderedAt)cur.firstOrderedAt=Date.now();
            patchRow(tidx,{menu:cur.menu,firstOrderedAt:cur.firstOrderedAt}); publishTotals();};
          menus.appendChild(btn);
        });

        controls.appendChild(ppl);controls.appendChild(bevs);controls.appendChild(menus);card.appendChild(controls);

        const orderedLines=[];CONFIG.menus.forEach((name,mi)=>{
          const total=(rows[headIdx].groupId?groupMembersIdx(rows[headIdx].groupId):[headIdx]).reduce((s,mi2)=>s+orderedFor(mi2,mi),0);
          if(total>0)orderedLines.push(name+' × '+total);
        });
        const orderedWrap=document.createElement('div');orderedWrap.className='kv';
        orderedWrap.innerHTML='<strong>주문내역</strong> '+(orderedLines.length?orderedLines.join(' · '):'—');card.appendChild(orderedWrap);

        const meta=document.createElement('div');meta.className='meta';
        const remainLines=[];CONFIG.menus.forEach((name,mi)=>{
          const remain=(rows[headIdx].groupId?groupMembersIdx(rows[headIdx].groupId):[headIdx]).reduce((s,mi2)=>s+remainingMenuFor(mi2,mi),0);
          if(remain>0)remainLines.push(name+' × '+remain);
        });
        const kv=document.createElement('div');kv.className='kv';kv.innerHTML='<strong>남은 수량</strong> '+(remainLines.length?remainLines.join(' · '):'—');meta.appendChild(kv);

        const line2=document.createElement('div');line2.className='line2';
        const sum=document.createElement('div');sum.className='sum';sum.textContent=fmtWon.format(aggregateForHead(headIdx).price)+'원';
        const pay=document.createElement('button');pay.className='btn ghost';pay.textContent='결제';
        pay.onclick=()=>{if(!confirm('정말 결제하시겠습니까?\n테이블: '+tno+'번 (헤드 '+(headIdx+1)+'번)\n합계: '+sum.textContent))return;
          const head=rows[tidx].head!=null?rows[tidx].head:tidx;let members=[tidx];
          if(rows[tidx].groupId!=null){const g=(groups||[]).find(x=>x&&x.id===rows[tidx].groupId);if(g)members=g.members.slice();}
          members.sort((a,b)=>a-b);
          const detail=[];let total=0;
          members.forEach(mi=>{
            const rr=rows[mi];
            CONFIG.menus.forEach((name,mIdx)=>{const ordered=(rr.menu?.[mIdx]||[]).filter(v=>v!==0).length;
              if(ordered>0){const price=(CONFIG.prices[name]||0)*ordered;total+=price;detail.push({tableNo:mi+1,menu:name,qty:ordered,price});}});
            if(rr.bev){[["COLA","콜라"],["CIDER","사이다"],["ZERO","제로콜라"]].forEach(([key,label])=>{
              const q=rr.bev[key]?.qty||0;if(q>0){const p=(CONFIG.prices[key]||0)*q;total+=p;detail.push({tableNo:mi+1,menu:label,qty:q,price:p});}});}
          });
          const receiptRef=db.ref('orders/'+ROOM+'/receipts').push();
          const payload={at:Date.now(),headTable:head+1,members:members.map(x=>x+1),items:detail,total};
          receiptRef.set(payload).then(()=>{
            const gid=rows[tidx].groupId;
            if(gid!=null){groupsRef.once('value').then(s=>{let list=s.val()||[];list=list.filter(x=>x.id!==gid);groupsRef.set(list);});}
            members.forEach(mi=>{tableRef(mi).set(emptyRow());}); publishTotals(); alert('결제 완료 · 영수증 로그에 기록되었습니다.');
          }).catch(()=>alert('영수증 기록 실패: 잠시 후 다시 시도해주세요.'));
        };
        card.appendChild(meta);line2.appendChild(sum);line2.appendChild(pay);card.appendChild(line2);
        grid.appendChild(card);
      }
    });

    /* 비고 */
    const memoCard=document.createElement('div');memoCard.className='card';
    memoCard.style.gridRow='4 / 6';memoCard.style.gridColumn='4 / 5';
    memoCard.innerHTML='<div class="note-area"><div class="head"><div class="tid">비고란</div></div><textarea id="globalMemo" placeholder="메모를 입력하세요."></textarea></div>';
    grid.appendChild(memoCard);
    memoRef.once('value').then(s=>{const v=s.val()||"";const ta=document.getElementById('globalMemo');ta.value=v;let t=null;ta.oninput=function(){clearTimeout(t);t=setTimeout(()=>memoRef.set(ta.value),300);};});

    /* 알고리즘 패널 */
    const alg=document.createElement('div');alg.className='card';
    alg.style.gridRow='3 / 6';alg.style.gridColumn='5 / 7';
    alg.innerHTML='<div class="header"><div class="tid">다음 음식</div><div class="chip">다음 나갈 테이블</div></div>';
    const box=document.createElement('div');box.className='alg';

    CONFIG.menus.forEach((name,mi)=>{
      const target=nextTableForMenu(mi,false);const left=document.createElement('div');left.className='left';left.innerHTML='<span class="menu">'+name+'</span>';
      const right=document.createElement('div');right.className='check';
      if(target){const nextTxt=document.createElement('span');nextTxt.className='next';nextTxt.textContent=target.tableNo+'번';
        const btn=document.createElement('button');btn.textContent='서빙 체크';btn.onclick=()=>{markOneServed(target.member,mi);render();};
        right.appendChild(nextTxt);right.appendChild(btn);}else{const small=document.createElement('span');small.className='small';small.textContent='대기 없음';right.appendChild(small);}
      const line=document.createElement('div');line.className='line';line.appendChild(left);line.appendChild(right);box.appendChild(line);
    });

    [["콜라",0],["사이다",1],["제로콜라",2]].forEach(([label,bi])=>{
      const target=nextTableForMenu(bi,true);const left=document.createElement('div');left.className='left';left.innerHTML='<span class="menu">'+label+'</span>';
      const right=document.createElement('div');right.className='check';
      if(target){const nextTxt=document.createElement('span');nextTxt.className='next';nextTxt.textContent=target.tableNo+'번';
        const btn=document.createElement('button');btn.textContent='서빙 체크';btn.onclick=()=>{markBeverageServed(target.member,bi);render();};
        right.appendChild(nextTxt);right.appendChild(btn);}else{const small=document.createElement('span');small.className='small';small.textContent='대기 없음';right.appendChild(small);}
      const line=document.createElement('div');line.className='line';line.appendChild(left);line.appendChild(right);box.appendChild(line);
    });

    alg.appendChild(box);grid.appendChild(alg);
  }

  /* 실시간 구독 */
  for(let i=0;i<CONFIG.tables;i++){
    tableRef(i).on('value',s=>{const v=s.val();if(!v){tableRef(i).set(emptyRow());return;}rows[i]=Object.assign(emptyRow(),v);render();});
  }
  groupsRef.on('value',s=>{groups=s.val()||[];render();});

  /* 합석 UI */
  const ui={select:false,selected:new Set()};
  const $toggle=$("#toggleSelect"),$make=$("#makeGroup"),$break=$("#breakGroup");

  function setSelectMode(on,silent){
    ui.select=on;
    if(on){
      if(!silent) alert('합석할 테이블 카드를 탭해서 선택하세요. 다시 누르면 해제됩니다.');
      grid.addEventListener('click',gridSel,true);
    }else{
      if(!silent) alert('합석 선택 해제');
      grid.removeEventListener('click',gridSel,true);
      ui.selected.clear(); enableGroupBtns(); render();
    }
  }
  $toggle.onclick=function(){ setSelectMode(!ui.select,false); };

  function cardTableNoFromEl(el){const tid=el.querySelector('.tid'); if(!tid) return null;const m=tid.textContent.match(/^(\d+)번/); return m?Number(m[1]):null;}
  function gridSel(e){
    const card=e.target.closest('.card'); if(!card) return;
    if(card.querySelector('.note-area')||card.querySelector('.alg')) return;
    const tno=cardTableNoFromEl(card); if(!tno) return;
    if(ui.selected.has(tno)) ui.selected.delete(tno); else ui.selected.add(tno);
    card.style.outline=ui.selected.has(tno)?'2px solid #3b82f6':'';
    enableGroupBtns();
  }
  function enableGroupBtns(){ $make.disabled=!(ui.select&&ui.selected.size>=2); $break.disabled=!(ui.select&&ui.selected.size>=1); }

  $make.onclick=function(){
    if(ui.selected.size<2) return;
    const arr=[...ui.selected].sort((a,b)=>a-b).map(idxFromTableNo);
    const head=arr[0];
    const gidAll=rows[arr[0]]?.groupId ?? null;
    const same = gidAll!=null && arr.every(mi=>rows[mi]?.groupId===gidAll);
    if(same){ setSelectMode(false,true); return; }
    const gid=Date.now(); const g={id:gid,head, members:arr};
    groupsRef.once('value').then(s=>{
      const list=(s.val()||[]); list.push(g); groupsRef.set(list);
      arr.forEach(mi=>tableRef(mi).update({groupId:gid, head:head}));
      setSelectMode(false,true);
    });
  };

  $break.onclick=function(){
    if(ui.selected.size===0) return;
    const arr=[...ui.selected].map(idxFromTableNo);
    groupsRef.once('value').then(s=>{
      let list=s.val()||[];
      arr.forEach(mi=>{const gid=rows[mi].groupId; if(gid!=null){list=list.filter(x=>x.id!==gid);} tableRef(mi).update({groupId:null, head:null});});
      groupsRef.set(list); setSelectMode(false,true);
    });
  };

  $("#resetAll").onclick=function(){
    if(!confirm('모든 테이블을 초기화할까요?'))return;
    for(let i=0;i<CONFIG.tables;i++){tableRef(i).set(emptyRow());}
    groupsRef.set([]); publishTotals();
  };

  setInterval(publishTotals,5000);
  setInterval(render, 30000); // 시간 경과 반영 주기 렌더
  render();
})();
</script>
</body>
</html>
